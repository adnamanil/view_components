name: Tests

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  snapshots:
    name: Snapshots
    # Don't run on main
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'
    - uses: actions/setup-node@v2
      with:
        node-version: 16
    - run: |
        npm i
        cd demo && npm i
    - name: Build and test with Rake
      run: |
        gem install bundler:2.2.9
        bundle config path vendor/bundle
        bundle update actionview activemodel activesupport railties actioncable
        bundle exec rake test:snapshots
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        commit_message: Generating component snapshots
        file_pattern: test/snapshots/**/*.png

    - name: "Changes detected"
      if: steps.auto-commit-action.outputs.changes_detected == 'true'
      uses: phulsechinmay/rewritable-pr-comment@v0.2.1
      with:
        message: |
          ### ⚠️ Visual differences found

          <details><summary>Our visual comparison tests found UI differences.</summary>
          Please review the differences by using the test artifacts to ensure that the changes were intentional.
          Artifacts can be downloaded and reviewed locally.

          Download links are available at the bottom of the workflow summary screen.
          ##### Example:
          ![artifacts section of workflow run](https://user-images.githubusercontent.com/13340707/181026915-2bda8a90-58e3-40ef-a2f6-c9c4af6e9c4a.png)
          If the changes are expected, please run `npm run test:visual:update-snapshots` to replace the previous fixtures.
          </details>

          [Review visual differences](https://github.com/primer/view_components/pull/${{ github.event.number }}/files?file-filters%5B%5D=.png&show-viewed-files=false)

        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        COMMENT_IDENTIFIER: 'visual-comparison-diff'
